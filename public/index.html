<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no, viewport-fit=cover">
	<meta name="theme-color" content="#000000">
	<meta content="IE=Edge" http-equiv="X-UA-Compatible">
	<title>Навигатор по МГТУ</title>

	<script type="text/javascript" src='https://unpkg.com/ngraph.path@1.3.1/dist/ngraph.path.min.js'></script>
	<script type="text/javascript" src='https://unpkg.com/ngraph.graph@19.0.0/dist/ngraph.graph.min.js'></script>

	<style>
		/* .graf {
			position: absolute;
		} */
	</style>

</head>

<body>
	<!-- <div id="map">
		<div id="background_map" style="position: absolute;">
			<img id="background_img" src="./src/GZ.png" alt="Фон карты не прогрузился" width="100">
		</div>
		<div class="graf" id="point_map">
			<svg id="svg_map" viewBox="0 0 1059 873" width="100" height="873">
			</svg>
		</div>
	</div> -->
	<div id="info" style="position: absolute; right: 15px; width: 300px;">
		<!-- <button onclick="save_json();">save dots</button>
				<button onclick="load_json();">load dots</button><br> -->

		<button onclick="find_roud();">find rout</button><br>
		last_dot:<input type="text" id="last_dot"><br>
		floor:<input type="number" value="1" id="floor" onchange="change_floor();">
		is stairs:<input type="checkbox" value="false" id="is_stairs">
		<div id="info_dots"></div>
	</div>

	<div id="root"></div>

	<script>
		// document.getElementById("background_img").width = Math.min(document.documentElement.clientWidth, 1059);
		// document.getElementById("point_map").innerHTML = `<svg id="svg_map" viewBox="0 0 1059 873" width="${Math.min(document.documentElement.clientWidth, 1059)}"></svg>`;

		var dots = JSON.parse(`[{"id":0,"floor":1,"cx":1013,"cy":837,"near_dots":[1]},{"id":1,"floor":1,"cx":1003,"cy":578,"near_dots":[2,0]},{"id":2,"is_stairs":true,"floor":1,"cx":796,"cy":583,"near_dots":[3,1,19]},{"id":3,"floor":1,"cx":660,"cy":587,"near_dots":[9,2]},{"id":4,"floor":1,"cx":656,"cy":266,"near_dots":[9,5,14]},{"id":5,"floor":1,"cx":747,"cy":174,"near_dots":[4,6]},{"id":6,"floor":1,"cx":765,"cy":61,"near_dots":[5,7]},{"id":7,"floor":1,"cx":995,"cy":51,"near_dots":[6,8]},{"id":8,"floor":1,"cx":1001,"cy":344,"near_dots":[7]},{"id":9,"floor":1,"cx":638,"cy":562,"near_dots":[13,3,4]},{"id":10,"floor":1,"cx":416,"cy":654,"near_dots":[13]},{"id":11,"floor":1,"cx":67,"cy":594,"near_dots":[12,13]},{"id":12,"floor":1,"cx":65,"cy":853,"near_dots":[11]},{"id":13,"floor":1,"cx":385,"cy":586,"near_dots":[11,10,9,14]},{"id":14,"floor":1,"cx":401,"cy":266,"near_dots":[4,13,15]},{"id":15,"floor":1,"cx":311,"cy":172,"near_dots":[16,14]},{"id":16,"floor":1,"cx":296,"cy":59,"near_dots":[17,15]},{"id":17,"floor":1,"cx":53,"cy":61,"near_dots":[18,16]},{"id":18,"floor":1,"cx":62,"cy":364,"near_dots":[17]},{"is_stairs":false,"id":19,"floor":2,"cx":1003,"cy":585,"near_dots":[20,2]},{"is_stairs":false,"id":20,"floor":2,"cx":1011,"cy":846,"near_dots":[19]}]`);
		var floor = 1;
		// draw_graf();

		function draw_graf() {
			document.getElementById("svg_map").innerHTML = "";
			for (i in dots) {
				var text_x = 10;
				if (dots[i].id > 9)
					text_x = 14;
				text_x -= 6;

				if (dots[i].floor == floor || dots[i].is_stairs == true) {
					document.getElementById("svg_map").innerHTML += `
								<circle id="${dots[i].id}" 
								cx="${dots[i].cx}" cy="${dots[i].cy}"
								r="12" stroke="black" stroke-width="1" fill="red"/>
		
								<text id="${dots[i].id}_text"
								x="${dots[i].cx - text_x}" y="${dots[i].cy + 6}"
								fill="white">${dots[i].id}</text>`;
					for (j in dots[i].near_dots) {
						if (document.getElementById(`${dots[i].near_dots[j]}_${dots[i].id}`) == null && dots[dots[i].near_dots[j]].floor == floor)
							document.getElementById("svg_map").innerHTML = `<line 
										id="${dots[i].id}_${dots[i].near_dots[j]}"
										x1="${dots[i].cx}" y1="${dots[i].cy}"
										x2="${dots[dots[i].near_dots[j]].cx}" y2="${dots[dots[i].near_dots[j]].cy}"
										style="stroke:rgb(255,0,0);stroke-width:2" />` +
								document.getElementById("svg_map").innerHTML;
					}
				}
			}
			document.getElementById("info_dots").innerHTML = JSON.stringify(dots);
		}

		function draw_path(path) {
			document.getElementById("svg_map").innerHTML = "";
			for (i in path) {
				var text_x = 10;
				if (path[i].id > 9)
					text_x = 14;
				text_x -= 6;

				document.getElementById("svg_map").innerHTML += `
							<circle id="${path[i].id}" 
							cx="${path[i].data.cx}" cy="${path[i].data.cy}"
							r="12" stroke="black" stroke-width="1" fill="red"/>
		
							<text id="${path[i].id}_text"
							x="${path[i].data.cx - text_x}" y="${path[i].data.cy + 6}"
							fill="white">${path[i].id}</text>`;

				if (i < (path.length - 1)) {
					console.log(i, parseInt(i) + 1, path[i].id, path[parseInt(i) + 1].id)
					document.getElementById("svg_map").innerHTML = `<line 
										id="${path[i].id}_${path[parseInt(i) + 1].id}"
										x1="${path[i].data.cx}" y1="${path[i].data.cy}"
										x2="${path[parseInt(i) + 1].data.cx}" y2="${path[parseInt(i) + 1].data.cy}"
										style="stroke:rgb(255,0,0);stroke-width:2" />` +
						document.getElementById("svg_map").innerHTML;
				}


			}
			document.getElementById("info_dots").innerHTML = JSON.stringify(dots);
		}

		function find_roud() {
			// let createGraph = require('ngraph.graph');
			console.log(ngraphPath)
			console.log(createGraph)
			let graph = createGraph();

			for (i in dots) {
				for (j in dots[i].near_dots) {
					if (graph.getLink(dots[i].id, dots[dots[i].near_dots[j]].id) == null) {
						graph.addLink(dots[i].id, dots[dots[i].near_dots[j]].id, { weight: 1 });
					}
				}
			}
			graph.forEachNode(function (node) {
				node.data = { 'cx': dots[node.id].cx, 'cy': dots[node.id].cy }
			});

			let pathFinder = ngraphPath.aStar(graph, {
				// We tell our pathfinder what should it use as a distance function:
				distance(fromNode, toNode, link) {
					// We don't really care about from/to nodes in this case,
					// as link.data has all needed information:
					return link.data.weight;
				}
			});
			let path = pathFinder.find(1, 19);
			console.log(path)
			draw_path(path);
			graph.forEachNode(function (node) {
				console.log(node.id, node.data);
			});
		}

		function change_floor() {
			floor = parseInt(document.getElementById("floor").value);
			draw_graf();
		}
	</script>
</body>

</html>